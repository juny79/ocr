# @package _global_

dataset_base_path: "/data/ephemeral/home/data/datasets/"   # Local dataset path

datasets:
  train_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/train.json
    transform: ${transforms.train_transform}
  val_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/val.json
    transform: ${transforms.val_transform}
  test_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/val.json
    transform: ${transforms.test_transform}
  predict_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/test
    annotation_path: null
    transform: ${transforms.test_transform}

transforms:
  train_transform:
    _target_: ${dataset_path}.DBTransforms
    _convert_: all
    transforms:
      # 1. 해상도 증가 (작은 글씨 대응)
      - _target_: albumentations.LongestMaxSize
        max_size: 960
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 960
        min_height: 960
        border_mode: 0
        p: 1.0

      # 2. 기하 변환 (촬영 각도 왜곡)
      - _target_: albumentations.Rotate
        limit: 10
        border_mode: 0
        p: 0.6
      - _target_: albumentations.ShiftScaleRotate
        shift_limit: 0.05
        scale_limit: 0.1
        rotate_limit: 5
        p: 0.5

      # 3. 조명 및 색상 (다양한 촬영 환경)
      - _target_: albumentations.RandomBrightnessContrast
        brightness_limit: 0.3
        contrast_limit: 0.3
        p: 0.7
      - _target_: albumentations.ColorJitter
        brightness: 0.2
        contrast: 0.2
        saturation: 0.1
        hue: 0.05
        p: 0.5

      # 4. 노이즈 및 블러 (저품질 이미지)
      - _target_: albumentations.OneOf
        transforms:
          - _target_: albumentations.GaussNoise
            var_limit: [10, 30]
          - _target_: albumentations.ISONoise
          - _target_: albumentations.MultiplicativeNoise
        p: 0.4
      - _target_: albumentations.OneOf
        transforms:
          - _target_: albumentations.MotionBlur
            blur_limit: 5
          - _target_: albumentations.GaussianBlur
            blur_limit: 5
        p: 0.3

      # 5. 선명도 강화 (글자-배경 경계)
      - _target_: albumentations.Sharpen
        alpha: [0.2, 0.5]
        lightness: [0.5, 1.0]
        p: 0.4

      # 6. 영수증 특화 증강 (Shadow, Fog)
      - _target_: albumentations.RandomShadow
        shadow_roi: [0, 0.5, 1, 1]
        p: 0.3
      - _target_: albumentations.RandomFog
        fog_coef_lower: 0.1
        fog_coef_upper: 0.3
        p: 0.2

      # 7. 기본 변환
      - _target_: albumentations.HorizontalFlip
        p: 0.5
      - _target_: albumentations.Normalize
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]

    keypoint_params:
      _target_: albumentations.KeypointParams
      format: 'xy'
      remove_invisible: True

  val_transform:
    _target_: ${dataset_path}.DBTransforms
    transforms:
      - _target_: albumentations.LongestMaxSize
        max_size: 960  # Validation도 동일 크기
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 960
        min_height: 960
        border_mode: 0
        p: 1.0
      - _target_: albumentations.Normalize
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]
    keypoint_params:
      _target_: albumentations.KeypointParams
      format: 'xy'
      remove_invisible: True

  test_transform:
    _target_: ${dataset_path}.DBTransforms
    transforms:
      - _target_: albumentations.LongestMaxSize
        max_size: 960
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 960
        min_height: 960
        border_mode: 0
        p: 1.0
      - _target_: albumentations.Normalize
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]
    keypoint_params:
      _target_: albumentations.KeypointParams
      format: 'xy'
      remove_invisible: True

dataloaders:
  train_dataloader:
    batch_size: 8  # 960px 해상도에 맞춰 배치 크기 감소
    shuffle: True
    num_workers: 4
  val_dataloader:
    batch_size: 8
    shuffle: False
    num_workers: 4
  test_dataloader:
    batch_size: 8
    shuffle: False
    num_workers: 4
  predict_dataloader:
    batch_size: 1
    shuffle: False
    num_workers: 4

collate_fn:
  _target_: ${dataset_path}.DBCollateFN
  shrink_ratio: 0.4
  thresh_min: 0.3
  thresh_max: 0.7
