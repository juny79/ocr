# @package _global_

# HRNet-W44 1024x1024 Optimized Dataset Configuration
# Based on 0.9886 score parameters
# 
# Key Changes:
# - Batch Size: 4 → 2
# - CollateFN shrink_ratio: 0.4 → 0.428584820771695
# - CollateFN thresh_max: 0.7 → 0.7506908133484191
# - CollateFN thresh_min: 0.3 → 0.33967147700431666

dataset_base_path: "/data/ephemeral/home/data/datasets/"

datasets:
  train_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/train_augmented_full.json
    transform: ${transforms.train_transform}
  val_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/val.json
    transform: ${transforms.val_transform}
  test_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/all
    annotation_path: ${dataset_base_path}jsons/val.json
    transform: ${transforms.test_transform}
  predict_dataset:
    _target_: ${dataset_path}.OCRDataset
    image_path: ${dataset_base_path}images/test
    annotation_path: null
    transform: ${transforms.test_transform}

transforms:
  train_transform:
    _target_: ${dataset_path}.DBTransforms
    _convert_: all
    transforms:
      # Resolution: 1024x1024
      - _target_: albumentations.LongestMaxSize
        max_size: 1024
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 1024
        min_height: 1024
        border_mode: 0
        p: 1.0
      # Geometric
      - _target_: albumentations.Rotate
        limit: 12
        border_mode: 0
        p: 0.6
      - _target_: albumentations.ShiftScaleRotate
        shift_limit: 0.06
        scale_limit: 0.12
        rotate_limit: 6
        border_mode: 0
        p: 0.5
      # Color / Brightness - Enhanced for Brightness&Contrast optimization
      - _target_: albumentations.RandomBrightnessContrast
        brightness_limit: 0.32                 # Increased based on sweep results
        contrast_limit: 0.28                   # Increased based on sweep results
        p: 0.7                                 # Increased probability
      - _target_: albumentations.ColorJitter
        brightness: 0.15
        contrast: 0.15
        saturation: 0.1
        hue: 0.05
        p: 0.4
      - _target_: albumentations.HueSaturationValue
        hue_shift_limit: 10
        sat_shift_limit: 15
        val_shift_limit: 10
        p: 0.4
      # Noise / Blur
      - _target_: albumentations.OneOf
        transforms:
          - _target_: albumentations.GaussNoise
            var_limit: [10, 25]
          - _target_: albumentations.ISONoise
          - _target_: albumentations.MultiplicativeNoise
        p: 0.3
      - _target_: albumentations.OneOf
        transforms:
          - _target_: albumentations.MotionBlur
            blur_limit: 5
          - _target_: albumentations.MedianBlur
            blur_limit: 5
          - _target_: albumentations.GaussianBlur
            blur_limit: 5
        p: 0.3
      # Shadow / Weather
      - _target_: albumentations.RandomShadow
        num_shadows_lower: 1
        num_shadows_upper: 2
        shadow_dimension: 4
        shadow_roi: [0, 0.4, 1, 1]
        p: 0.3
      # Flip
      - _target_: albumentations.HorizontalFlip
        p: 0.5
    keypoint_params:
      _target_: albumentations.KeypointParams
      format: xy
      remove_invisible: True

  val_transform:
    _target_: ${dataset_path}.DBTransforms
    _convert_: all
    transforms:
      - _target_: albumentations.LongestMaxSize
        max_size: 1024
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 1024
        min_height: 1024
        border_mode: 0
        p: 1.0
    keypoint_params:
      _target_: albumentations.KeypointParams
      format: xy
      remove_invisible: True

  test_transform:
    _target_: ${dataset_path}.DBTransforms
    _convert_: all
    transforms:
      - _target_: albumentations.LongestMaxSize
        max_size: 1024
        p: 1.0
      - _target_: albumentations.PadIfNeeded
        min_width: 1024
        min_height: 1024
        border_mode: 0
        p: 1.0
    keypoint_params:
      _target_: albumentations.KeypointParams
      format: xy
      remove_invisible: True

dataloaders:
  train_dataloader:
    batch_size: 2                          # Optimized batch size (reduced from 4)
    shuffle: True
    num_workers: 4
    pin_memory: True
    drop_last: True
    collate_fn:
      _target_: ${collate_fn_path}.DBCollateFN
      shrink_ratio: 0.428584820771695      # Optimized shrink ratio
      thresh_min: 0.33967147700431666      # Optimized thresh_min
      thresh_max: 0.7506908133484191       # Optimized thresh_max
  val_dataloader:
    batch_size: 2                          # Matched with train
    shuffle: False
    num_workers: 4
    pin_memory: True
    collate_fn:
      _target_: ${collate_fn_path}.DBCollateFN
      shrink_ratio: 0.428584820771695      # Optimized shrink ratio
      thresh_min: 0.33967147700431666      # Optimized thresh_min
      thresh_max: 0.7506908133484191       # Optimized thresh_max
  test_dataloader:
    batch_size: 2                          # Matched with train
    shuffle: False
    num_workers: 4
    pin_memory: True
    collate_fn:
      _target_: ${collate_fn_path}.DBCollateFN
      shrink_ratio: 0.428584820771695      # Optimized shrink ratio
      thresh_min: 0.33967147700431666      # Optimized thresh_min
      thresh_max: 0.7506908133484191       # Optimized thresh_max
  predict_dataloader:
    batch_size: 2                          # Matched with train
    shuffle: False
    num_workers: 4
    pin_memory: True
    collate_fn:
      _target_: ${collate_fn_path}.DBCollateFN
      shrink_ratio: 0.428584820771695      # Optimized shrink ratio
      thresh_min: 0.33967147700431666      # Optimized thresh_min
      thresh_max: 0.7506908133484191       # Optimized thresh_max
