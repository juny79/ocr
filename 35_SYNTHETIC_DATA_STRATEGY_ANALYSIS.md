# 영수증 합성 데이터 전략 분석 리포트

## 🎯 요약 (Executive Summary)

**결론: 합성 데이터 전략은 구현 가능하나, 제한적 효과 예상 ⚠️**

현재 성능: **Hmean 0.9832** (이미 매우 높은 수준)
예상 효과: **+0.1~0.3% 향상** (시간 대비 낮은 ROI)
구현 난이도: **높음** (3-5일 소요)

**최종 권장**: ❌ 합성 데이터 전략 **권장하지 않음**
- 현재 성능이 이미 0.9832로 매우 높음
- Recall은 97.90%로 이미 우수 (False Negative 2.1%만)
- 합성 데이터로 개선할 여지 제한적
- 시간 대비 효율성 낮음 (3-5일 투자 → +0.1~0.3%)

---

## 📊 1단계: 이미지 레벨 분석

### ✅ 데이터셋 규모
```
총 이미지: 3,272개
총 텍스트 박스: 382,462개
이미지당 평균 박스: 116.9개
```

### 📐 해상도 분포 (샘플 100개 기준)
```
이미지 해상도: 다양한 크기 (추가 샘플링 필요)
※ 주의: 이미지 파일 경로 확인 필요
```

### 💡 합성 데이터 가이드라인
- **합성 해상도**: 실제 데이터셋 해상도 분포 반영 필요
- **추가 분석 필요**: 100개 샘플로는 부족, 전체 데이터셋 분석 권장

---

## 🔤 2단계: 텍스트 박스 레벨 분석

### ✅ 박스 크기 분포

| 지표 | 값 | 설명 |
|------|-----|------|
| **총 박스** | 382,462개 | 전체 학습 데이터 |
| **평균 크기** | W=80.5px, H=24.3px | 가로로 긴 텍스트 |
| **평균 면적** | 2,040.9px² | 충분히 큰 크기 |

### ⚠️ Small Object 분석 (핵심!)

```
Small Object (≤32px²):    182개 (0.05%)  ← 극소수!
Tiny Object (≤100px²):  5,512개 (1.44%)  ← 매우 적음
```

**중요 발견**:
- **Small Object는 전체의 0.05%에 불과** → Hard Case가 거의 없음!
- **Tiny Object도 1.44%** → 작은 글자 문제가 심각하지 않음
- **현재 Recall 97.90%** → 이미 대부분의 박스 검출 중

### 📐 종횡비 분석

```
평균 Aspect Ratio: 3.81 (가로로 긴 텍스트)
가로로 긴 박스 (AR>2): 53.0%  ← 영수증 특성 반영
세로로 긴 박스 (AR<0.5): 5.0%  ← 소수
```

**합성 데이터 전략**:
- ✅ 가로로 긴 텍스트 (AR 2~5) 집중
- ❌ 세로 텍스트는 우선순위 낮음

### 🎯 박스 밀도 및 배치

```
이미지당 평균: 116.9개 박스
최소/최대: 31개 / 403개
```

**분석**:
- 매우 밀집된 텍스트 환경
- 평균 100개 이상의 박스 → 겹침 가능성 높음
- 합성 시 밀집도 유지 필요

---

## 📝 3단계: 텍스트 콘텐츠 분석

### 📐 텍스트 방향 분포

| 방향 | 개수 | 비율 | 분석 |
|------|------|------|------|
| **Horizontal** | 351,007개 | 91.8% | 압도적 다수 ✅ |
| None | 31,381개 | 8.2% | 방향 미지정 |
| Irregular | 11개 | 0.0% | 극소수 |
| Vertical | 2개 | 0.0% | 무시 가능 |

**중요 결론**:
- ✅ **좌→우 Horizontal 텍스트가 91.8%** 
- ✅ **TTA Horizontal Flip이 위험한 이유 재확인**
- ✅ **합성 데이터도 Horizontal 중심으로 생성**

### 🌐 언어 분포

| 언어 | 개수 | 비율 |
|------|------|------|
| **한글 (ko)** | 216,312개 | 90.5% |
| 영어 (en) | 22,572개 | 9.4% |
| 기타 (others) | 64개 | 0.0% |

**합성 데이터 전략**:
- ✅ **한글 90%, 영어 10%** 비율 유지
- ✅ 숫자, 특수문자 (₩, -, :) 포함
- ✅ 영수증 도메인 단어: "합계", "TOTAL", "카드결제"

### 📍 좌측 정렬 경향

```
좌측 배치 박스: 22.0%
```

**분석**:
- 영수증이지만 좌측 정렬이 예상보다 낮음
- 중앙 또는 우측 배치도 많음
- 합성 시 다양한 배치 전략 필요

---

## ⚠️ 4단계: Hard Case 분석

### 🔍 현재 모델 성능 (Stage 3 기준)

```
Hmean: 0.9832
Precision: 0.9885 (매우 높음)
Recall: 0.9790 (매우 높음)
```

### 📊 False Negative 분석

```
검출 실패 비율: 2.1% (100 - 97.90)
총 박스 중 미검출: ~8,032개 (추정)
```

**미검출 박스 원인 추정**:
1. **Small Object**: 182개 (0.05%) - 극소수
2. **저해상도/블러**: 추정 ~1,000개 (0.26%)
3. **낮은 대비**: 추정 ~2,000개 (0.52%)
4. **기타**: 추정 ~4,850개 (1.27%)

### 💡 합성 데이터 우선순위

| 우선순위 | 타겟 | 예상 개선 | 구현 난이도 |
|---------|------|----------|-----------|
| 🥇 **1순위** | 저대비 텍스트 | +0.05~0.10% | 중간 |
| 🥈 **2순위** | 블러/흐림 | +0.03~0.08% | 쉬움 |
| 🥉 **3순위** | Small Object | +0.01~0.05% | 어려움 |
| 🏅 **4순위** | 겹침/밀집 | +0.02~0.05% | 중간 |

**합계 예상 효과**: +0.11~0.28% (낙관적)

---

## 🛠️ 합성 데이터 생성 전략

### ✅ 구현 가능한 전략

#### 전략 A: 기존 이미지 변형 (빠름 ⭐⭐⭐⭐⭐)
```python
# 1. 밝기/대비 변형
brightness_factor = [0.6, 0.7, 0.8, 1.2, 1.3]
contrast_factor = [0.6, 0.7, 0.8, 1.2, 1.3]

# 2. 블러 추가
gaussian_blur = [1, 2, 3]
motion_blur = [(5,0), (10,0), (15,0)]

# 3. 노이즈 추가
gaussian_noise = [0.01, 0.02, 0.03]

# 박스 좌표는 변경 없음 → 안전!
```

**장점**:
- 빠른 구현 (1-2일)
- 박스 좌표 변경 없음 (안전)
- 즉시 학습 가능

**단점**:
- 새로운 텍스트 추가 불가
- 제한적 다양성

**예상 효과**: +0.05~0.15%

---

#### 전략 B: TextRecognitionDataGenerator 활용 (중간 ⭐⭐⭐)
```python
# pip install trdg
from trdg.generators import GeneratorFromDict

# 영수증 특화 단어 사전
receipt_words = [
    "합계", "TOTAL", "카드결제", "현금", 
    "부가세", "VAT", "거스름돈", "영수증",
    # ... 100개 단어
]

# 생성 파라미터
generator = GeneratorFromDict(
    count=10000,  # 10,000개 합성 이미지
    strings=receipt_words,
    fonts=['NanumGothic.ttf', 'Arial.ttf'],
    language='ko,en',
    size=24,  # 평균 텍스트 크기
    skewing_angle=0,  # 영수증은 회전 없음
    distorsion_type=1,  # 약간의 왜곡
    blur=2,
    background_type=0,  # 흰색 배경
)
```

**장점**:
- 다양한 폰트/스타일
- 완벽한 GT 박스
- 영수증 특화 가능

**단점**:
- 실제 영수증과 차이
- 배경/레이아웃 부자연스러움
- 구현 시간 2-3일

**예상 효과**: +0.08~0.20%

---

#### 전략 C: 복합 전략 (느림 ⭐)
```python
# 1. 실제 영수증에서 텍스트 영역 추출
# 2. 다른 영수증 배경에 합성
# 3. 밝기/대비/블러 변형
```

**장점**:
- 가장 현실적
- 다양한 Hard Case 생성

**단점**:
- 구현 복잡 (5일+)
- 박스 좌표 변환 오류 위험
- 시간 대비 효율 낮음

**예상 효과**: +0.10~0.28% (불확실)

---

## 🎯 최종 권장 사항

### ❌ 권장: 합성 데이터 전략 적용하지 않음

**이유**:
1. **현재 성능 이미 매우 높음**: Hmean 0.9832, Recall 97.90%
2. **Small Object가 거의 없음**: 전체의 0.05%만 (Hard Case 부족)
3. **시간 대비 효율 낮음**: 3-5일 투자 → +0.1~0.3% (기대치 낮음)
4. **리스크 존재**: 합성 데이터 품질 낮으면 오히려 성능 하락 가능

### ✅ 대안: 현재 전략 유지

**현재 최적 전략**:
1. ✅ Stage 4 앙상블 제출 (thresh=0.24, box=0.27)
2. ✅ 예상: Hmean 0.9837~0.9841
3. ✅ 팀원 대비: +0.31~0.35% 우세
4. ✅ 안정적이고 확실한 성능 향상

---

## 📊 비교 분석

| 전략 | 예상 효과 | 구현 시간 | 리스크 | 추천도 |
|------|----------|----------|--------|--------|
| **현재 유지** (Stage 4) | +0.05~0.09% | 0일 | 없음 | ⭐⭐⭐⭐⭐ |
| 합성 데이터 A (변형) | +0.05~0.15% | 1-2일 | 낮음 | ⭐⭐ |
| 합성 데이터 B (생성) | +0.08~0.20% | 2-3일 | 중간 | ⭐ |
| 합성 데이터 C (복합) | +0.10~0.28% | 5일+ | 높음 | ❌ |

---

## 🔍 구현 가능성 세부 분석

### ✅ 기술적 구현 가능성: 높음

**필요 도구**:
- OpenCV (이미지 변형)
- PIL/Pillow (이미지 조작)
- trdg (텍스트 생성)
- NumPy (좌표 변환)

**구현 단계**:
1. 데이터 증강 파이프라인 구축 (1일)
2. 합성 데이터 생성 (1-2일)
3. 학습 데이터셋 통합 (0.5일)
4. 재학습 및 검증 (1-2일)

**총 소요 시간**: 3.5~5.5일

### ⚠️ 효과 예측: 제한적

**긍정적 요인**:
- 저대비 텍스트 증강 → Recall +0.05~0.10%
- 블러/노이즈 추가 → Robustness 향상

**부정적 요인**:
- **현재 Recall 이미 97.90%** → 개선 여지 2.1%만
- **Small Object 0.05%** → Hard Case 거의 없음
- **합성 데이터 품질 문제** → 오히려 성능 하락 가능

**현실적 예상**: +0.1~0.3% (낙관적 시나리오)

---

## 💡 실행 계획 (만약 진행한다면)

### Phase 1: Quick Win (1-2일) - 권장 안 함
```python
# augmentation_pipeline.py
def create_synthetic_data_v1():
    """
    기존 이미지 변형만으로 합성 데이터 생성
    """
    for img_path, boxes in dataset:
        # 1. 밝기 감소 (저대비 시뮬레이션)
        dark_img = adjust_brightness(img, factor=0.6)
        save_synthetic(dark_img, boxes, suffix='_dark')
        
        # 2. 블러 추가
        blurred_img = gaussian_blur(img, sigma=2)
        save_synthetic(blurred_img, boxes, suffix='_blur')
        
        # 3. 노이즈 추가
        noisy_img = add_gaussian_noise(img, std=0.02)
        save_synthetic(noisy_img, boxes, suffix='_noise')
```

### Phase 2: 재학습 (1-2일)
```bash
# K-Fold 재학습 (5 Folds)
cd /data/ephemeral/home/baseline_code
python runners/run_kfold.py --use_synthetic=True
```

### Phase 3: 검증 (0.5일)
```bash
# 앙상블 생성 및 제출
python runners/generate_kfold_ensemble_improved.py
```

**총 소요 시간**: 3-5일
**예상 결과**: Hmean 0.9832 → 0.9842~0.9862 (낙관적)

---

## 🚨 주의사항

### ⚠️ 합성 데이터 적용 시 리스크

1. **품질 문제**:
   - 비현실적인 합성 데이터 → 모델 혼란
   - 오히려 성능 하락 가능 (0.9832 → 0.9800?)

2. **시간 투자**:
   - 3-5일 소요
   - 현재 파라미터 튜닝 (Stage 4)은 즉시 가능

3. **기회 비용**:
   - 합성 데이터 대신 다른 전략 (ResNet50-UNet 등) 시도 가능

4. **재학습 비용**:
   - 5-Fold 재학습 → GPU 시간/비용

---

## 🎓 결론

### ❌ 최종 결정: 합성 데이터 전략 채택하지 않음

**근거**:
1. ✅ 현재 성능 충분히 높음 (0.9832, 팀원 +0.26%)
2. ✅ Small Object 비율 극히 낮음 (0.05%)
3. ✅ Recall 이미 97.90% (개선 여지 2.1%만)
4. ❌ 시간 대비 효율 낮음 (3-5일 → +0.1~0.3%)
5. ❌ 리스크 존재 (품질 문제 시 성능 하락)

### ✅ 권장 전략

**즉시 실행**:
1. Stage 4 앙상블 제출 (thresh=0.24, box=0.27)
2. 예상 Hmean: 0.9837~0.9841
3. 안정적이고 확실한 성능 향상

**추가 고려 사항** (합성 데이터 대신):
- ResNet50-UNet 아키텍처 테스트 (팀원 전략)
- Early Stopping + 1024 해상도 재학습
- Hybrid Ensemble (HRNet + ResNet50)

---

## 📈 EDA 핵심 발견 요약

| 항목 | 발견 사항 | 합성 데이터 관련성 |
|------|----------|------------------|
| **Small Object** | 0.05% (182개) | ❌ Hard Case 거의 없음 |
| **Horizontal 텍스트** | 91.8% | ✅ 좌→우 방향 중심 생성 |
| **한글/영어 비율** | 90.5% / 9.4% | ✅ 언어 비율 유지 |
| **평균 박스 크기** | 80.5×24.3px | ✅ 유사 크기 생성 |
| **Recall** | 97.90% | ❌ 개선 여지 제한적 (2.1%) |

---

## 📚 참고 자료

### 합성 데이터 생성 도구
- **TextRecognitionDataGenerator (trdg)**: https://github.com/Belval/TextRecognitionDataGenerator
- **SynthText**: https://github.com/ankush-me/SynthText
- **UnrealText**: https://github.com/Jyouhou/UnrealText

### 영수증 데이터셋
- **CORD**: Consolidated Receipt Dataset
- **SROIE**: Scanned Receipts OCR and Information Extraction
- **WildReceipt**: Receipt Dataset in the Wild

### 참고 논문
- "What You Get Is What You See: A Visual Markup Decompiler" (CORD)
- "ICDAR2019 Robust Reading Challenge on Scanned Receipts OCR and IE" (SROIE)

---

## ⏭️ Next Steps

**권장 액션**:
1. ✅ Stage 4 앙상블 즉시 제출
2. ✅ 리더보드 결과 확인
3. ✅ 합성 데이터는 시간 여유 있을 때만 고려
4. ✅ 대신 다른 전략 (아키텍처 변경 등) 우선 검토

**합성 데이터 재고 조건**:
- Stage 4 결과가 0.9830 미만인 경우
- 시간 여유가 5일 이상 있는 경우
- 다른 모든 전략 시도 후

**현실적 목표**:
- 현재: 0.9832 (팀원 +0.26%)
- Stage 4: 0.9837~0.9841 (팀원 +0.31~0.35%)
- 최종: 0.9840+ 달성 (합성 데이터 없이도 가능!)
