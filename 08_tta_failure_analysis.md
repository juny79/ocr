# TTA 실패 원인 분석 보고서

## 🚨 문제 상황

**제출 결과**:
- H-Mean: 0.9626 → **0.7825** (-18.7%)
- Precision: 0.9649 → **0.7103** (-25.5%)
- Recall: 0.9623 → 0.8752 (-8.7%)

## 🔍 원인 분석

### 1. 박스 수 급증
```
Original: 142 boxes
Flipped: 140 boxes
Merged: 215 boxes (정상이면 140~150개)
```

### 2. 좌표 변환 실패
```python
Original box: [[280, 1121], [541, 1130]]
Flipped box: [[234, 1131], [397, 1126]]
```

**문제점**: 
- Albumentations HorizontalFlip은 **이미지만 플립**, 좌표는 변환 안 됨
- DBNet 모델이 플립된 이미지를 보고 예측 → 박스 좌표는 플립된 이미지 기준
- 하지만 원본 이미지 해상도로 역변환 시 **자동으로 x 좌표 반전이 안 됨**
- 결과: 좌우가 뒤집힌 위치의 박스들이 생성됨

### 3. 병합 로직 문제
- IoU 30%로 중복 제거 시도
- 하지만 플립된 박스들이 **완전히 다른 위치**에 있어서 중복으로 인식 안 됨
- 원본 140개 + 잘못된 위치 140개 = 280개 → NMS로 약간 줄어 215개

## 📊 영향 분석

**Precision 대폭 하락 이유**:
- 잘못된 위치의 박스 75개 추가 (215 - 140)
- False Positive 대량 발생
- 0.9649 → 0.7103 (25.5% 하락)

**Recall 약간 하락 이유**:
- 플립으로 인한 약간의 정보 손실
- 일부 경계선 박스 누락

## ✅ 해결 방안

### 즉시 적용 가능한 대안

#### 1. **기존 Aggressive 설정으로 복귀** ⭐⭐⭐⭐⭐
- 파일: `submission_resnet50_aggressive.csv`
- 점수: H-Mean 0.9626
- **이것이 현재 최고 점수**

#### 2. **임계값 추가 미세조정** ⭐⭐⭐⭐
```yaml
thresh: 0.20  # 0.22 → 0.20
box_thresh: 0.23  # 0.25 → 0.23
```
예상: H-Mean 0.963~0.965

#### 3. **Fold 1 훈련 + 2-Fold 앙상블** ⭐⭐⭐⭐⭐
- 소요 시간: 2시간
- 예상: H-Mean 0.966~0.968
- **가장 확실한 개선 방법**

### TTA를 제대로 하려면

복잡한 좌표 변환 로직 필요:
1. 이미지 플립
2. 모델 예측
3. **박스 좌표 수동 반전**: x' = image_width - x
4. 원본과 병합

→ 구현 복잡도 대비 효과 미미 (예상 +0.1~0.2%)

## 🎯 권장 조치

**즉시**: 
1. `submission_resnet50_aggressive.csv` 기준으로 작업 (H-Mean 0.9626)
2. 임계값만 살짝 조정해서 재예측 (5분)

**중기** (시간 여유 있으면):
1. Fold 1 훈련 (2시간)
2. 2-Fold 앙상블 (5분)
3. 예상 H-Mean: **0.967~0.970**

**TTA는 포기**: 복잡도 대비 효과 낮음, 앙상블이 훨씬 효과적
