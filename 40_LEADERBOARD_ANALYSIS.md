# 리더보드 결과 분석 및 최적화 전략

## 📊 제출 결과 비교

| 설정 | H-Mean | Precision | Recall | 박스 수 | 변화 |
|------|--------|-----------|--------|---------|------|
| **기존 베스트** (min_votes=3) | **0.9843** | **0.9881** | **0.9814** | 45,356 | 기준 |
| min2_iou50 | 0.9780 | 0.9736 | 0.9830 | 46,256 | **-0.0063** ❌ |
| min2_iou45 | 0.9788 | 0.9745 | 0.9836 | 46,245 | **-0.0055** ❌ |

---

## 🔍 핵심 발견

### 1. **min_votes=2 전략 실패**
```
기존 베스트: min_votes=3, iou_threshold=0.5
→ H: 0.9843, P: 0.9881, R: 0.9814

min_votes=2 시도:
→ H: 0.9780-0.9788 (-0.006)
→ Precision: 0.9736-0.9745 (-0.014) ⚠️ 치명적 하락
→ Recall: 0.9830-0.9836 (+0.002) 미미한 상승
```

**진단**: 
- **False Positive 급증** (Precision -1.4%p)
- Recall 개선은 미미 (+0.2%p)
- **트레이드오프 실패**: 손실 > 이득

---

### 2. **IoU 0.50→0.45 효과**
```
min2_iou50: H=0.9780, P=0.9736, R=0.9830 (46,256개)
min2_iou45: H=0.9788, P=0.9745, R=0.9836 (46,245개)

변화: H +0.0008, P +0.0009, R +0.0006
박스: -11개 (0.02% 감소)
```

**검증된 사실**:
- ✅ IoU 감소 → 중복 제거 증가 (46,256→46,245)
- ✅ Precision 소폭 개선 (+0.09%p)
- ✅ 방향은 맞지만, **min_votes=2 문제가 더 큼**

---

## 🎯 문제의 본질

### **min_votes=3 vs min_votes=2 비교**

```
min_votes=3 (기존):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Fold 0: ████████   |
Fold 2:   ████████ | → 3개 이상 동의 → 채택 ✓
Fold 3:     ████   |
Fold 1: (없음)
Fold 4: (없음)

결과: 45,356개 박스, P=0.9881 (높은 신뢰도)
```

```
min_votes=2 (실험):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Fold 0: ████████   | → 2개만 동의해도 채택 ✓
Fold 2:   ████████ |
Fold 3:     ████   | (이것도 채택)
Fold 1: █ (노이즈) | → 이것도 채택! ⚠️
Fold 4: (없음)

결과: 46,256개 박스 (+900개, +2%), P=0.9736 (-1.4%p)
```

**결론**: 
- 900개 추가 박스 중 **대부분이 False Positive**
- 실제 놓친 글자(True Positive)는 소수
- min_votes=2는 **너무 관대함**

---

## 📉 수치 분석

### **Precision 하락의 의미**
```
P: 0.9881 → 0.9736 (-0.0145)

의미:
- 기존: 100개 제출 → 98.81개 정답
- 현재: 100개 제출 → 97.36개 정답
- 손실: 1.45개/100개 = 1.45% False Positive 증가
```

### **Recall 상승의 의미**
```
R: 0.9814 → 0.9836 (+0.0022)

의미:
- 기존: 정답 100개 중 98.14개 찾음
- 현재: 정답 100개 중 98.36개 찾음
- 이득: 0.22개/100개 = 0.22% 추가 발견
```

### **H-Mean 계산**
```
H = 2 * (P * R) / (P + R)

기존: 2 * (0.9881 * 0.9814) / (0.9881 + 0.9814) = 0.9843
min2_iou45: 2 * (0.9745 * 0.9836) / (0.9745 + 0.9836) = 0.9788

차이: -0.0055 (-0.56%p)
```

**트레이드오프 실패**:
- Precision 손실: -1.45%p
- Recall 이득: +0.22%p
- **손실이 이득의 6.6배** 🚨

---

## 🎯 최적화 전략

### **Phase 1: 즉시 실행 (Precision 회복)**

#### **Option A: min_votes=4 (보수적)**
```python
# 예상 효과:
- 박스 수: 44,000-45,000개 (최소 2개 fold 컷)
- Precision: 0.988-0.990 (FP 대폭 감소)
- Recall: 0.980-0.982 (소폭 하락)
- 목표 H-Mean: 0.9840-0.9850
```

**근거**: min_votes=4는 "4개 이상 fold가 동의해야 채택"
- 매우 높은 신뢰도
- FP 최소화
- 이미 테스트한 조합: min4_iou50 (44,462개)

#### **Option B: min_votes=3 + IoU 미세조정**
```python
# 기존 베스트 (0.9843) 근처에서 미세 조정
조합:
1. min3_iou45: 중복 제거 약간 강화
2. min3_iou55: 중복 제거 약간 약화
3. min3_iou40: 공격적 중복 제거
```

**근거**: 
- min_votes=3이 이미 검증됨 (0.9843)
- IoU만 조정으로 +0.0002-0.0005 개선 가능

---

### **Phase 2: thresh/box_thresh 재탐색**

#### **현재 베스트 베이스라인**
```
thresh=0.23, box_thresh=0.26 → H=0.9843
(min_votes=3, iou_threshold=0.5 기준)
```

#### **새로운 가설**
```
min_votes=2는 FP를 증가시킴
→ thresh/box_thresh를 더 높여서 FP 사전 필터링

테스트 조합:
1. thresh=0.25, box_thresh=0.28 (더 엄격)
2. thresh=0.27, box_thresh=0.30 (매우 엄격)
3. thresh=0.24, box_thresh=0.27 (중간)

목표: FP 억제 + Recall 유지
```

**실행 시간**: 각 8분 (5-Fold 재추론 필요)

---

### **Phase 3: 장기 전략**

#### **1. DB Loss Beta 조정 (재학습)**
- 현재 beta=10
- 제안: beta=12-15 (Precision↑, 경계 더 정확)
- 시간: 150시간 (5-Fold)

#### **2. Augmentation 추가**
- Brightness/Contrast 증강
- 작은 글자 검출 개선
- 시간: 150시간

---

## 🚀 즉시 실행 액션 플랜

### **단계 1: min_votes=3/4 복귀** (5분)
```bash
# 이미 생성된 CSV 활용
hrnet_ensemble_min3_iou50.csv (기존 베스트 재생성)
hrnet_ensemble_min4_iou50.csv (보수적 전략)
```

### **단계 2: min3 + IoU 미세조정** (10분)
```bash
# min3_iou45, min3_iou40 생성
python runners/generate_min3_iou_variants.py
```

### **단계 3: 제출 순서**
```
1순위: min3_iou50 (기존 베스트 재현 확인)
2순위: min4_iou50 (Precision 극대화)
3순위: min3_iou45 (균형점)
4순위: min3_iou40 (공격적 중복 제거)
```

### **단계 4: 결과 기반 결정**
```
if min4_iou50 > 0.9843:
    → min_votes=4 방향으로 미세조정
elif min3_iou45 > 0.9843:
    → IoU 감소 방향 탐색
else:
    → thresh/box_thresh 재탐색
```

---

## 📌 핵심 교훈

### **배운 것**
1. ❌ **min_votes=2는 너무 관대** (FP +2%, Precision -1.4%p)
2. ✅ **IoU 감소는 유효** (중복 제거 개선, +0.0008)
3. ⚠️ **트레이드오프 주의** (Recall 이득 << Precision 손실)

### **검증된 사실**
- min_votes=3, iou_threshold=0.5가 **균형점**
- Precision 0.9881은 **이미 매우 높음**
- 추가 개선은 **미세 조정**으로만 가능 (+0.0002-0.0005)

### **다음 목표**
- **단기**: min_votes=3-4 + IoU 미세조정 → H=0.9845 목표
- **중기**: thresh/box_thresh 재탐색 → H=0.9850 목표
- **장기**: 재학습(beta, augmentation) → H=0.9860+ 목표

---

## 🔧 실행 가능한 코드

생성할 스크립트:
1. `generate_min3_iou_variants.py` - min3 기반 IoU 조정
2. `generate_min4_variants.py` - min4 기반 조합
3. `test_higher_thresh.py` - thresh/box_thresh 상향 조정

예상 시간:
- min3/min4 variants: 10분
- thresh/box_thresh: 8분/조합

**즉시 시작 가능!**
