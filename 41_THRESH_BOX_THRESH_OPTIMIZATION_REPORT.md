# Threshold & Box Threshold 최적화 실험 보고서

**최종 작성일**: 2026-02-08  
**실험 기간**: 2024-12-30 ~ 2026-01-31  
**최종 달성 점수**: H-Mean **0.9843** (이전 0.9747 대비 +0.96%p 상승)

---

## 📊 핵심 결과 요약

| 단계 | Thresh | Box Thresh | H-Mean | Precision | Recall | 변화 | 상태 |
|------|--------|-----------|--------|-----------|--------|------|------|
| **초기** | 0.30 | 0.40 | 0.9747 | 0.9890 | 0.9633 | 기준 | ✅ |
| **Step 1** | 0.27 | 0.30 | **0.9805** | 0.9884 | 0.9741 | +0.0058 | ⭐ |
| **Step 2** | 0.26 | 0.29 | **0.9822** | 0.9884 | 0.9776 | +0.0075 | ⭐⭐ |
| **최종** | 0.23 | 0.26 | **0.9843** | 0.9881 | 0.9814 | +0.0096 | ⭐⭐⭐ |

---

## 🔍 상세 실험 과정

### Phase 1: 초기 분석 (2024-12-30)

**현황**:
- 초기 설정: thresh=0.30, box_thresh=0.40
- 초기 점수: H=0.9747, P=0.9890, R=0.9633
- 문제점: Recall이 낮음 (-0.17%p vs 팀원)

**전략**:
- Recall 개선 우선
- thresh/box_thresh 하향 조정
- Precision은 0.9850+ 유지 목표

---

### Phase 2: 첫 번째 최적화 (2024-12-31)

#### 목표: Hmean 0.9800+ 달성

**실험 1: Aggressive Tuning**
```
파라미터 변경:
  thresh: 0.30 → 0.27 (-0.03)
  box_thresh: 0.40 → 0.30 (-0.10)

결과:
  H: 0.9747 → 0.9805 (+0.0058, +0.59%p) ✅
  P: 0.9890 → 0.9884 (-0.0006, -0.06%p) ✓
  R: 0.9633 → 0.9741 (+0.0108, +1.08%p) ✅✅

분석:
  • Recall 개선 효과: 1.08%p
  • Precision 안정: -0.06%p만 하락
  • Hmean 상승: 의도한 방향 성공 ✓
```

**통찰**:
- Recall 개선의 선형성 확인: thresh/box_thresh 0.03/0.10 하향 → Recall +1.08%p
- Precision 안정성: High threshold 덕분에 FP 통제 ✓

---

### Phase 3: 두 번째 최적화 (2025-01-01)

#### 목표: Hmean 0.9820+ 달성 (팀원 0.9806 초과)

**실험 2: Fine-tuning Variation**
```
파라미터 변경:
  thresh: 0.27 → 0.26 (-0.01)
  box_thresh: 0.30 → 0.29 (-0.01)

결과:
  H: 0.9805 → 0.9822 (+0.0017, +0.17%p) ✅
  P: 0.9884 → 0.9884 (+0.0000, +0.00%p) ✓
  R: 0.9741 → 0.9776 (+0.0035, +0.35%p) ✅

분석:
  • 미세 조정: -0.01/-0.01 변경으로 +0.35%p Recall
  • Precision 유지: 정확히 동일 수준 (0.9884)
  • Hmean 개선: 누적 +0.0075 (+0.77%p)

누적 효과:
  초기 0.9747 → 0.9822 (+0.0075, +0.77%p)
  팀원 0.9806과 비교: +0.0016 초과 ✅✅
```

**통찰**:
- 미세 조정의 수렴점 도달: 0.01 단위 변경으로 효과 명확
- Precision-Recall 균형점 발견: 현재 설정이 최적 근처
- 추가 개선 여지: 아직 가능성 있음

---

### Phase 4: 최종 최적화 (2025-01-02)

#### 목표: Hmean 0.9830+ 달성 (팀원 0.9806 초과)

**실험 3: Final Push**
```
파라미터 변경:
  thresh: 0.26 → 0.23 (-0.03)
  box_thresh: 0.29 → 0.26 (-0.03)

결과:
  H: 0.9822 → 0.9843 (+0.0021, +0.21%p) ✅
  P: 0.9884 → 0.9881 (-0.0003, -0.03%p) ✓
  R: 0.9776 → 0.9814 (+0.0038, +0.38%p) ✅

분석:
  • 추가 하향: -0.03/-0.03 변경으로 +0.38%p Recall
  • Precision 거의 무손실: -0.03%p만 하락
  • Hmean 추가 상승: +0.0021

최종 누적:
  초기 0.9747 → 0.9843 (+0.0096, +0.96%p)
  팀원 0.9806 vs 0.9843: +0.0037 (0.37%p 초과) ✅✅✅
```

**통찰**:
- 최종 수렴: 0.23/0.26에서 최적점 도달
- 추가 개선 한계: 더 이상 하향 조정 위험 수준
- 정체 신호: Recall 개선 속도 둔화 (1.08% → 0.35% → 0.38%)

---

## 📈 최적화 곡선 분석

### Hmean 개선 추이

```
Phase 1                Phase 2                Phase 3                Phase 4
(초기)                (Step 1)                (Step 2)              (최종)

0.9747    ──+0.0058→   0.9805    ──+0.0017→   0.9822    ──+0.0021→   0.9843
  ↓                       ↓                       ↓                       ↓
기준점                   팀원 근처              팀원 초과              최종 달성

개선 패턴:
- Step 1: 대폭 개선 (+0.59%p) - 거리감 큼
- Step 2: 미세 개선 (+0.17%p) - 수렴 중
- Step 3: 한계 개선 (+0.21%p) - 최적점 근처
```

### Precision-Recall 트레이드오프

```
           Precision        Recall
초기:       0.9890          0.9633     (P 우위, R 열세)
Step 1:     0.9884          0.9741     (P 소폭 하락, R 큰 개선)
Step 2:     0.9884          0.9776     (P 유지, R 미세 개선)
최종:       0.9881          0.9814     (P 안정적, R 최적)

분석:
- Precision 안정성: 0.9881-0.9890 범위 (매우 좁음 = 안정적)
- Recall 개선율: 0.9633 → 0.9814 (+1.81%p = 강력한 개선)
- 균형점: 0.23/0.26에서 달성
```

---

## 🎯 parameter 민감도 분석

### Thresh 변화에 따른 효과

| Thresh | 변화 | Recall 변화 | Precision 변화 | 해석 |
|--------|------|------------|----------------|------|
| 0.30 | 기준 | - | - | 매우 엄격 (FN 높음) |
| 0.27 | -0.03 | +1.08%p | -0.06%p | 합리적 균형 |
| 0.26 | -0.01 | +0.35%p | 0.00%p | 미세 조정 |
| 0.23 | -0.03 | +0.38%p | -0.03%p | 최종 최적점 |

**패턴 분석**:
```
Thresh 감소에 따른 효과:
- 0.30→0.27: 큰 변화 (-0.03) → 큰 효과 (+1.08%p)
- 0.27→0.26: 작은 변화 (-0.01) → 중간 효과 (+0.35%p)
- 0.26→0.23: 중간 변화 (-0.03) → 중간 효과 (+0.38%p)

동향: 수렴 중, 추가 하향 위험 증가
```

### Box Threshold 변화에 따른 효과

| Box Thresh | 변화 | Recall 효과 | FP 통제 | 의미 |
|-----------|------|-----------|--------|------|
| 0.40 | 기준 | 낮음 (0.9633) | 우수 | 너무 엄격 |
| 0.30 | -0.10 | +1.08%p | 우수 | 큰 개선 |
| 0.29 | -0.01 | +0.35%p | 우수 | 미세 개선 |
| 0.26 | -0.03 | +0.38%p | 우수 | 최적 균형 |

**패턴 분석**:
```
Box_thresh 감소의 이중 효과:
1. Recall 개선 (더 많은 박스 통과)
2. FP 위험 (잘못된 박스도 통과)

BUT 현재까지 Precision 거의 무손실:
→ 거짓 양성 상대적으로 적음
→ 모델 quality 양호
```

---

## 💡 실험에서 배운 핵심 인사이트

### 1. Threshold의 역할
```
thresh = 픽셀 수준의 신뢰도 문턱값

thresh ↓ (0.30 → 0.23)
  ↓
더 많은 픽셀이 "텍스트" 판정
  ↓
더 큰/완전한 영역 검출
  ↓
Recall ↑, Precision ↓(미미)
```

### 2. Box Threshold의 역할
```
box_thresh = 최종 박스의 신뢰도 문턱값

box_thresh ↓ (0.40 → 0.26)
  ↓
낮은 신뢰도의 박스도 통과
  ↓
더 많은 박스 예측
  ↓
Recall ↑↑, Precision ↓(안정적)
```

### 3. 균형 조정의 과학
```
P: 0.9881 (매우 높음)
R: 0.9814 (매우 높음)
→ Hmean = 2 × P × R / (P + R) = 0.9843

특성: 두 수치가 모두 높을 때,
      한쪽을 0.01%p 개선 → 전체 개선 0.005%p
      
→ 추가 개선 어려움 (이미 최적에 가까움)
```

### 4. 수렴 신호 감지
```
개선 속도 둔화:
  Step 1: +0.59%p (급격한 상승)
  Step 2: +0.17%p (속도 감소)
  Step 3: +0.21%p (한계 수준)

→ 0.23/0.26 근처에서 최적점
→ 추가 하향 위험성 증가
```

---

## 📋 최종 결론

### 달성 내용
- ✅ H-Mean: 0.9747 → **0.9843** (+0.96%p)
- ✅ Precision: 0.9890 → 0.9881 (안정적)
- ✅ Recall: 0.9633 → 0.9814 (+1.81%p)
- ✅ 팀원 기준: 0.9806 대비 **+0.37%p 초과**

### 최적 파라미터
```yaml
min_votes: 3
thresh: 0.23
box_thresh: 0.26
```

### 추가 개선 전망
```
현재 상태: 거의 최적 상태
→ 추가 포스트프로세싱 튜닝은 미미한 효과 (+0.0002-0.0005)
→ 주요 개선은 재학습 필요 (DB Loss beta, 증강 등)
```

### 리더보드 제출 기록

| 제출 # | 설정 | H-Mean | Precision | Recall | 날짜 |
|--------|------|--------|-----------|--------|------|
| 1 | t0.30, b0.40 | 0.9747 | 0.9890 | 0.9633 | 2024-12-30 |
| 2 | t0.27, b0.30 | 0.9805 | 0.9884 | 0.9741 | 2024-12-31 |
| 3 | t0.26, b0.29 | 0.9822 | 0.9884 | 0.9776 | 2025-01-01 |
| 4 | **t0.23, b0.26** | **0.9843** | **0.9881** | **0.9814** | **2025-01-02** |

---

## 🔬 기술 세부사항

### 실험 환경
- **모델**: HRNet-W44
- **Training**: 5-Fold Cross Validation
- **Ensemble**: min_votes=3 (3개 이상 fold 동의)
- **Dataset**: CORD-v2, SROIE, WildReceipt
- **Evaluation**: CLEval Metric

### 파라미터 변경 이유
```
초기 (t0.30, b0.40):
  - 보수적 설정
  - Precision 우위 (0.9890)
  - Recall 열세 (0.9633)
  - 느낌: False Positive 막기에 집중

최종 (t0.23, b0.26):
  - 공격적 설정
  - Precision 유지 (0.9881)
  - Recall 개선 (0.9814)
  - 느낌: Recall 극대화하되 Precision 보호

변경 동기: Hmean = 조화평균
  → P와 R이 균형을 이룰 때 최대
  → 초기는 P 우위 → Hmean 하락 부분 존재
  → 균형점 찾기 = 최적화
```

---

## 📌 향후 작업 계획

### 단기 (즉시 가능)
1. ~~thresh/box_thresh 미세조정~~ ✅ 완료
2. 앙상블 파라미터 조정 (min_votes, iou_threshold) - 진행 중
3. 가중치 조정 (fold별 가중) - 테스트 예정

### 중기 (1-2주)
1. DB Loss beta 조정 (10→12-15)
2. Augmentation 강화 (Brightness/Contrast)
3. 재학습 (150시간, 5-Fold)

### 장기 (2주 이상)
1. 앙상블 모델 추가 (다른 backbone: EfficientNet, ConvNeXt)
2. 대규모 데이터 증강
3. 고급 포스트프로세싱 (OCR-specific tricks)

---

**최종 상태**: 포스트프로세싱 최적화 완료 ✅  
**다음 세션**: 앙상블 파라미터 튜닝 및 재학습 전략 수립
